{"version":3,"file":"index.js","sources":["../src/Logger.js"],"sourcesContent":["const Levels = [\n  'trace',\n  'debug',\n  'info',\n  'warn',\n  'error',\n  'fatal'\n];\n\nconst CONFIG_DELIMITER = ',';\nconst PART_DELIMITER = '|';\nconst NAME_DELIMITER = ':';\nconst CONFIG_SPLIT_REGEX = new RegExp(`[\\\\s${CONFIG_DELIMITER}]+`);\nconst PART_SPLIT_REGEX = new RegExp(`[\\\\s${PART_DELIMITER}]+`);\nconst ENV_KEY = 'LOGGER';\n\nfunction isString (arg) {\n  return (arg?.constructor === String);\n}\n\nfunction isError (arg) {\n  return (arg instanceof Error);\n}\n\nfunction bounded (pattern) {\n  return new RegExp(`^${pattern}$`);\n}\n\nexport default class Logger {\n  static includes = [];\n  static excludes = [];\n  static memo = {};\n\n  static _time = function () {\n    return (new Date()).toISOString();\n  }\n\n  constructor (context = {}) {\n    if (isString(context)) {\n      context = {\n        name: context\n      };\n    }\n\n    if (!('name' in context)) {\n      throw new Error('Must specify name for logger');\n    }\n\n    this.context = context;\n    const {name} = context;\n    this.name = name;\n  }\n\n  static set time (fn) {\n    this._time = fn;\n  }\n\n  static enabled ({level, name}) {\n    const memo_key = [level, name].join(PART_DELIMITER);\n    if (memo_key in this.memo) {\n      return this.memo[memo_key];\n    }\n\n    for (const exclude of this.excludes) {\n      // excludes ignore level\n      if (exclude.test(name)) {\n        this.memo[memo_key] = false;\n        return false\n      }\n    }\n\n    const enabled = this.includes.some((include)=> {\n      const level_index = Levels.indexOf(level);\n      const this_index = Levels.indexOf(include.level);\n      const level_enabled = (level_index >= this_index);\n      return level_enabled && include.name.test(name);\n    });\n\n    this.memo[memo_key] = enabled;\n    return enabled;\n  }\n\n  static set config (configs) {\n    this.includes = [];\n    this.excludes = [];\n    this.memo = {};\n\n    if (!Array.isArray(configs)) {\n      if (isString(configs)) {\n        configs = configs.split(CONFIG_SPLIT_REGEX);\n      } else {\n        throw new Error('When setting .config pass string or array of strings');\n      }\n    }\n\n    for (let config of configs) {\n      const is_exclude = (config[0] === '-');\n      if (is_exclude) {\n        if (config.includes(PART_DELIMITER)) {\n          throw new Error('Exclude roles should not include level');\n        }\n        const name = bounded(config.substr(1));\n        this.excludes.push(name);\n      }\n\n      let [name, level] = config.split(PART_SPLIT_REGEX);\n\n      name = name.replace(/\\*/g, '.*?');\n      name = bounded(name);\n\n      if (!level) {\n        level = 'error';\n      }\n      const valid_level = Levels.includes(level);\n      if (!valid_level) {\n        throw new Error(`Invalid level ${level}`);\n      }\n\n      this.includes.push({name, level});\n    }\n  }\n\n  static readConfig () {\n    function read () {\n      let config;\n      if (typeof process !== 'undefined') {\n        config = process.env?.[ENV_KEY];\n        if (config) {\n          return config;\n        }\n      }\n\n      if (typeof window !== 'undefined') {\n        config = window.localStorage?.[ENV_KEY];\n        if (config) {\n          return config;\n        }\n      }\n\n      return '*';\n    }\n\n    this.config = read();\n  }\n\n  child (context = {}) {\n    if (isString(context)) {\n      context = {\n        name: context\n      };\n    }\n\n    let {name} = this.context;\n    if ('name' in context) {\n      name = [name, context.name].join(NAME_DELIMITER);\n    }\n\n    const new_context = {...this.context, ...context, name};\n    const child = new this.constructor(new_context);\n    child.level = this.level;\n\n    return child;\n  }\n\n  _log (...args) {\n    let body = {...this.context};\n\n    // DERP: Should probably just limit to two args\n    // but oh well i'm a fucken idiot\n    for (const arg of args) {\n      const has_message = ('message' in body);\n      if (isString(arg)) {\n        if (!has_message) {\n          body.message = arg;\n        }\n      } else if (isError(arg)) {\n        if (!has_message) {\n          body.message = arg.message;\n        }\n        const props = Object.getOwnPropertyNames(arg);\n        const payload = props.reduce((payload, key)=> {\n          payload[key] = arg[key];\n          return payload;\n        }, {});\n        body.error = JSON.stringify(payload);\n      } else if (arg) {\n        body = {...body, ...arg};\n      }\n    }\n    if (!('time' in body)) {\n      body.time = this.constructor._time();\n    }\n    return body;\n  }\n}\n\nLogger.levels = Levels;\nLevels.forEach((level)=> {\n  const {console} = global;\n  const fn = (level === 'fatal') ? 'error' : level;\n  Logger.prototype[level] = function log (...args) {\n    const body = this._log(...args);\n    const {message, name} = body;\n    const enabled = Logger.enabled({level, name});\n    if (enabled) {\n      console[fn](message, body);\n    }\n  };\n  Levels[level] = level;\n});\n\nLogger.readConfig();\n"],"names":["Levels","CONFIG_DELIMITER","PART_DELIMITER","NAME_DELIMITER","CONFIG_SPLIT_REGEX","RegExp","PART_SPLIT_REGEX","ENV_KEY","isString","arg","constructor","String","isError","Error","bounded","pattern","Logger","context","name","time","fn","_time","enabled","level","memo_key","join","memo","exclude","excludes","test","includes","some","include","level_index","indexOf","this_index","level_enabled","config","configs","Array","isArray","split","is_exclude","substr","push","replace","valid_level","readConfig","read","process","env","window","localStorage","child","new_context","_log","args","body","has_message","message","props","Object","getOwnPropertyNames","payload","reduce","key","error","JSON","stringify","Date","toISOString","levels","forEach","console","global","prototype","log"],"mappings":"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"}