{"version":3,"file":"index.umd.js","sources":["../src/Logger.js"],"sourcesContent":["const Levels = [\n  'trace',\n  'debug',\n  'info',\n  'warn',\n  'error',\n  'fatal'\n];\n\nconst CONFIG_DELIMITER = ',';\nconst PART_DELIMITER = '|';\nconst NAME_DELIMITER = ':';\nconst CONFIG_SPLIT_REGEX = new RegExp(`[\\\\s${CONFIG_DELIMITER}]+`);\nconst PART_SPLIT_REGEX = new RegExp(`[\\\\s${PART_DELIMITER}]+`);\nconst ENV_KEY = 'LOGGER';\n\nfunction isString (arg) {\n  return (arg?.constructor === String);\n}\n\nfunction isError (arg) {\n  return (arg instanceof Error);\n}\n\nfunction bounded (pattern) {\n  return new RegExp(`^${pattern}$`);\n}\n\nexport default class Logger {\n  static includes = [];\n  static excludes = [];\n  static memo = {};\n\n  static _time = function () {\n    return (new Date()).toISOString();\n  }\n\n  constructor (context = {}) {\n    if (isString(context)) {\n      context = {\n        name: context\n      };\n    }\n\n    if (!('name' in context)) {\n      throw new Error('Must specify name for logger');\n    }\n\n    this.context = context;\n    const {name} = context;\n    this.name = name;\n  }\n\n  static set time (fn) {\n    this._time = fn;\n  }\n\n  static enabled ({level, name}) {\n    const memo_key = [level, name].join(PART_DELIMITER);\n    if (memo_key in this.memo) {\n      return this.memo[memo_key];\n    }\n\n    for (const exclude of this.excludes) {\n      // excludes ignore level\n      if (exclude.test(name)) {\n        this.memo[memo_key] = false;\n        return false\n      }\n    }\n\n    const enabled = this.includes.some((include)=> {\n      const level_index = Levels.indexOf(level);\n      const this_index = Levels.indexOf(include.level);\n      const level_enabled = (level_index >= this_index);\n      return level_enabled && include.name.test(name);\n    });\n\n    this.memo[memo_key] = enabled;\n    return enabled;\n  }\n\n  static set config (configs) {\n    this.includes = [];\n    this.excludes = [];\n    this.memo = {};\n\n    if (!Array.isArray(configs)) {\n      if (isString(configs)) {\n        configs = configs.split(CONFIG_SPLIT_REGEX);\n      } else {\n        throw new Error('When setting .config pass string or array of strings');\n      }\n    }\n\n    for (let config of configs) {\n      const is_exclude = (config[0] === '-');\n      if (is_exclude) {\n        if (config.includes(PART_DELIMITER)) {\n          throw new Error('Exclude roles should not include level');\n        }\n        const name = bounded(config.substr(1));\n        this.excludes.push(name);\n      }\n\n      let [name, level] = config.split(PART_SPLIT_REGEX);\n\n      name = name.replace(/\\*/g, '.*?');\n      name = bounded(name);\n\n      if (!level) {\n        level = 'error';\n      }\n      const valid_level = Levels.includes(level);\n      if (!valid_level) {\n        throw new Error(`Invalid level ${level}`);\n      }\n\n      this.includes.push({name, level});\n    }\n  }\n\n  static readConfig () {\n    function read () {\n      let config;\n      if (typeof process !== 'undefined') {\n        config = process.env?.[ENV_KEY];\n        if (config) {\n          return config;\n        }\n      }\n\n      if (typeof window !== 'undefined') {\n        config = window.localStorage?.[ENV_KEY];\n        if (config) {\n          return config;\n        }\n      }\n\n      return '*';\n    }\n\n    this.config = read();\n  }\n\n  child (context = {}) {\n    if (isString(context)) {\n      context = {\n        name: context\n      };\n    }\n\n    let {name} = this.context;\n    if ('name' in context) {\n      name = [name, context.name].join(NAME_DELIMITER);\n    }\n\n    const new_context = {...this.context, ...context, name};\n    const child = new this.constructor(new_context);\n    child.level = this.level;\n\n    return child;\n  }\n\n  _log (...args) {\n    let body = {...this.context};\n\n    // DERP: Should probably just limit to two args\n    // but oh well i'm a fucken idiot\n    for (const arg of args) {\n      const has_message = ('message' in body);\n      if (isString(arg)) {\n        if (!has_message) {\n          body.message = arg;\n        }\n      } else if (isError(arg)) {\n        if (!has_message) {\n          body.message = arg.message;\n        }\n        const props = Object.getOwnPropertyNames(arg);\n        const payload = props.reduce((payload, key)=> {\n          payload[key] = arg[key];\n          return payload;\n        }, {});\n        body.error = JSON.stringify(payload);\n      } else if (arg) {\n        body = {...body, ...arg};\n      }\n    }\n    if (!('time' in body)) {\n      body.time = this.constructor._time();\n    }\n    return body;\n  }\n}\n\nLogger.levels = Levels;\nLevels.forEach((level)=> {\n  const {console} = global;\n  const fn = (level === 'fatal') ? 'error' : level;\n  Logger.prototype[level] = function log (...args) {\n    const body = this._log(...args);\n    const {message, name} = body;\n    const enabled = Logger.enabled({level, name});\n    if (enabled) {\n      console[fn](message, body);\n    }\n  };\n  Levels[level] = level;\n});\n\nLogger.readConfig();\n"],"names":["Levels","CONFIG_DELIMITER","PART_DELIMITER","NAME_DELIMITER","CONFIG_SPLIT_REGEX","RegExp","PART_SPLIT_REGEX","ENV_KEY","isString","arg","constructor","String","isError","Error","bounded","pattern","Logger","context","name","time","fn","_time","enabled","level","memo_key","join","memo","exclude","excludes","test","includes","some","include","level_index","indexOf","this_index","level_enabled","config","configs","Array","isArray","split","is_exclude","substr","push","replace","valid_level","readConfig","read","process","env","window","localStorage","child","new_context","_log","args","body","has_message","message","props","Object","getOwnPropertyNames","payload","reduce","key","error","JSON","stringify","Date","toISOString","levels","forEach","console","global","prototype","log"],"mappings":"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"}