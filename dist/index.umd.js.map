{"version":3,"file":"index.umd.js","sources":["../src/Logger.js"],"sourcesContent":["const Levels = [\n  'trace',\n  'debug',\n  'info',\n  'warn',\n  'error',\n  'fatal'\n];\n\nconst COMBO_ENV_DELIMITER = '|';\nconst NAME_DELIMITER = ':';\n\nfunction isString (arg) {\n  return (arg?.constructor === String);\n}\n\nfunction isError (arg) {\n  return (arg instanceof Error);\n}\n\nexport default class Logger {\n  static includes = [];\n  static excludes = [];\n  static _level = 'info';\n  static _time = function () {\n    return (new Date()).toISOString();\n  }\n\n  constructor (context = {}) {\n    if (isString(context)) {\n      context = {\n        name: context\n      };\n    }\n\n    if (!('name' in context)) {\n      throw new Error('Must specify name for logger');\n    }\n\n    this.context = context;\n    const {name} = context;\n    this.name = name;\n  }\n\n  static set time (fn) {\n    this._time = fn;\n  }\n\n  static enabled ({level, name}) {\n    // check level first since its cheaper array index\n    // comparison than the name regex stuffs\n    return this.levelEnabled(level) && this.nameEnabled(name);\n  }\n\n  static levelEnabled (level) {\n    const level_index = Levels.indexOf(level);\n    const this_index = Levels.indexOf(this.level);\n    return level_index >= this_index;\n  }\n\n  static nameEnabled (name) {\n    // TODO: probably can assume this happens only once\n    // before run so we can then memoize on name?\n    if (name === '*') {\n      return true;\n    }\n\n    for (const exclude of this.excludes) {\n      if (exclude.test(name)) {\n        return false;\n      }\n    }\n\n    return this.includes.some((include)=> {\n      return include.test(name);\n    });\n  }\n\n  static get level () {\n    return this._level;\n  }\n\n  static set level (level) {\n    const valid_level = Levels.includes(level);\n    if (!valid_level) {\n      throw new Error(`Invalid level ${level}`);\n    }\n    this._level = level;\n  }\n\n  static readConfig () {\n    function getConfig (key) {\n      let config;\n\n      if (typeof process !== 'undefined') {\n        config = process.env?.[key];\n        if (config) {\n          return config;\n        }\n      }\n\n      if (typeof window !== 'undefined') {\n        config = window.localStorage?.[key];\n        if (config) {\n          return config;\n        }\n      }\n\n      return null;\n    }\n\n    const combo = getConfig('LOGGER');\n    if (combo) {\n      const parts = combo.split(COMBO_ENV_DELIMITER);\n      if (parts.length > 1) {\n        const [level, names] = parts;\n        this.level = level;\n        this.names = names;\n      } else {\n        this.names = combo;\n      }\n    } else {\n      const level = getConfig('LOGGER_LEVEL');\n      if (level) {\n        this.level = level;\n      }\n\n      const names = getConfig('LOGGER_NAMES');\n      if (names) {\n        this.names = names;\n      }\n    }\n  }\n\n  static set names (names) {\n    if (!Array.isArray(names)) {\n      if (isString(names)) {\n        names = names.split(/[\\s,]+/);\n      } else {\n        throw new Error('setNames expects string or array or strings');\n      }\n    }\n\n    for (let name of names) {\n      name = name.replace(/\\*/g, '.*?');\n      const exclude = (name[0] === '-');\n      let dest = 'includes';\n      if (exclude) {\n        name = name.substr(1);\n        dest = 'excludes';\n      }\n      const regex = new RegExp(`^${name}$`);\n      this[dest].push(regex);\n    }\n  }\n\n  child (context = {}) {\n    if (isString(context)) {\n      context = {\n        name: context\n      };\n    }\n\n    let {name} = this.context;\n    if ('name' in context) {\n      name = [name, context.name].join(NAME_DELIMITER);\n    }\n\n    const new_context = {...this.context, ...context, name};\n    const child = new this.constructor(new_context);\n    child.level = this.level;\n\n    return child;\n  }\n\n  _log (...args) {\n    let body = {...this.context};\n\n    // DERP: Should probably just limit to two args\n    // but oh well i'm a fucken idiot\n    for (const arg of args) {\n      const has_message = ('message' in body);\n      if (isString(arg)) {\n        if (!has_message) {\n          body.message = arg;\n        }\n      } else if (isError(arg)) {\n        if (!has_message) {\n          body.message = arg.message;\n        }\n        const props = Object.getOwnPropertyNames(arg);\n        const payload = props.reduce((payload, key)=> {\n          payload[key] = arg[key];\n          return payload;\n        }, {});\n        body.error = JSON.stringify(payload);\n      } else if (arg) {\n        body = {...body, ...arg};\n      }\n    }\n    if (!('time' in body)) {\n      body.time = this.constructor._time();\n    }\n    return body;\n  }\n}\n\nLogger.levels = Levels;\nLevels.forEach((level)=> {\n  const {console} = global;\n  const fn = (level === 'fatal') ? 'error' : level;\n  Logger.prototype[level] = function log (...args) {\n    const body = this._log(...args);\n    const {message, name} = body;\n    const enabled = Logger.enabled({level, name});\n    if (enabled) {\n      console[fn](message, body);\n    }\n  };\n  Levels[level] = level;\n});\n\nLogger.readConfig();\n"],"names":["Levels","COMBO_ENV_DELIMITER","NAME_DELIMITER","isString","arg","constructor","String","isError","Error","Logger","context","name","time","fn","_time","enabled","level","levelEnabled","nameEnabled","level_index","indexOf","this_index","exclude","excludes","test","includes","some","include","_level","valid_level","readConfig","getConfig","key","config","process","env","window","localStorage","combo","parts","split","length","names","Array","isArray","replace","dest","substr","regex","RegExp","push","child","join","new_context","_log","args","body","has_message","message","props","Object","getOwnPropertyNames","payload","reduce","error","JSON","stringify","Date","toISOString","levels","forEach","console","global","prototype","log"],"mappings":"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"}